/* =========================================================
   BASIC QUERIES
   ========================================================= */

-- 1. List all unique cities where customers are located.
SELECT DISTINCT customer_city
FROM customers;

-- 2. Count the number of orders placed in 2017.
SELECT COUNT(*) AS orders_2017
FROM orders
WHERE EXTRACT(YEAR FROM order_purchase_timestamp) = 2017;

-- 3. Find the total sales per category.
SELECT
    p.product_category,
    SUM(oi.price + oi.freight_value) AS total_sales
FROM order_items oi
JOIN products p ON oi.product_id = p.product_id
GROUP BY p.product_category
ORDER BY total_sales DESC;

-- 4. Calculate the percentage of orders that were paid in installments.
SELECT
    ROUND(
        100.0 * COUNT(DISTINCT CASE WHEN payment_installments > 1 THEN order_id END)
        / COUNT(DISTINCT order_id),
        2
    ) AS installment_percentage
FROM payments;

-- 5. Count the number of customers from each state.
SELECT
    customer_state,
    COUNT(*) AS customer_count
FROM customers
GROUP BY customer_state
ORDER BY customer_count DESC;

/* =========================================================
   INTERMEDIATE QUERIES
   ========================================================= */

-- 1. Calculate the number of orders per month in 2018.
SELECT
    DATE_TRUNC('month', order_purchase_timestamp) AS order_month,
    COUNT(*) AS total_orders
FROM orders
WHERE EXTRACT(YEAR FROM order_purchase_timestamp) = 2018
GROUP BY order_month
ORDER BY order_month;

-- 2. Find the average number of products per order, grouped by customer city.
SELECT
    customer_city,
    CEIL(AVG(order_product_count)) AS avg_products_per_order
FROM (
    SELECT
        o.order_id,
        c.customer_city,
        COUNT(oi.order_item_id) AS order_product_count
    FROM orders o
    JOIN customers c ON o.customer_id = c.customer_id
    JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY o.order_id, c.customer_city
) sub
GROUP BY customer_city
ORDER BY avg_products_per_order DESC;

-- 3. Calculate the percentage of total revenue contributed by each product category.
SELECT
    p.product_category,
    ROUND(
        100.0 * SUM(oi.price + oi.freight_value)
        / SUM(SUM(oi.price + oi.freight_value)) OVER (),
        2
    ) AS revenue_percentage
FROM order_items oi
JOIN products p ON oi.product_id = p.product_id
GROUP BY p.product_category
ORDER BY revenue_percentage DESC;

-- 4. Identify the correlation between product price and number of times a product has been purchased.
SELECT
    CORR(product_price, purchase_count) AS price_purchase_correlation
FROM (
    SELECT
        product_id,
        AVG(price) AS product_price,
        COUNT(*) AS purchase_count
    FROM order_items
    GROUP BY product_id
) sub;

-- 5. Calculate the total revenue generated by each seller, and rank them by revenue.
SELECT
    seller_id,
    total_revenue,
    RANK() OVER (ORDER BY total_revenue DESC) AS revenue_rank
FROM (
    SELECT
        seller_id,
        SUM(price + freight_value) AS total_revenue
    FROM order_items
    GROUP BY seller_id
) sub;

/* =========================================================
   ADVANCED QUERIES
   ========================================================= */

-- 1. Calculate the moving average of order values for each customer over their order history.
SELECT
    customer_id,
    order_purchase_timestamp,
    order_value,
    CEIL(
        AVG(order_value) OVER (
            PARTITION BY customer_id
            ORDER BY order_purchase_timestamp
            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
        )
    ) AS moving_avg_order_value
FROM (
    SELECT
        o.customer_id,
        o.order_purchase_timestamp,
        SUM(oi.price + oi.freight_value) AS order_value
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY o.customer_id, o.order_purchase_timestamp
) sub
ORDER BY customer_id, order_purchase_timestamp;

-- 2. Calculate the cumulative sales per month for each year.
SELECT
    year,
    month,
    monthly_sales,
    SUM(monthly_sales) OVER (
        PARTITION BY year
        ORDER BY month
    ) AS cumulative_sales
FROM (
    SELECT
        EXTRACT(YEAR FROM order_purchase_timestamp) AS year,
        EXTRACT(MONTH FROM order_purchase_timestamp) AS month,
        SUM(oi.price + oi.freight_value) AS monthly_sales
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY year, month
) sub
ORDER BY year, month;

-- 3. Calculate the year-over-year growth rate of total sales.
SELECT
    year,
    total_sales,
    ROUND(
        100.0 * (total_sales - LAG(total_sales) OVER (ORDER BY year))
        / LAG(total_sales) OVER (ORDER BY year),
        2
    ) AS yoy_growth_percentage
FROM (
    SELECT
        EXTRACT(YEAR FROM order_purchase_timestamp) AS year,
        SUM(oi.price + oi.freight_value) AS total_sales
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY year
) sub
ORDER BY year;

-- 4. Calculate the retention rate of customers
--    (customers who made another purchase within 6 months of their first purchase).
WITH first_purchase AS (
    SELECT
        customer_id,
        MIN(order_purchase_timestamp) AS first_order_date
    FROM orders
    GROUP BY customer_id
),
repeat_purchase AS (
    SELECT DISTINCT
        o.customer_id
    FROM orders o
    JOIN first_purchase fp
        ON o.customer_id = fp.customer_id
       AND o.order_purchase_timestamp > fp.first_order_date
       AND o.order_purchase_timestamp <= fp.first_order_date + INTERVAL '6 months'
)
SELECT
    ROUND(
        100.0 * COUNT(DISTINCT rp.customer_id)
        / COUNT(DISTINCT fp.customer_id),
        2
    ) AS retention_rate_percentage
FROM first_purchase fp
LEFT JOIN repeat_purchase rp
    ON fp.customer_id = rp.customer_id;

-- 5. Identify the top 3 customers who spent the most money in each year.
SELECT
    year,
    customer_id,
    total_spent
FROM (
    SELECT
        EXTRACT(YEAR FROM o.order_purchase_timestamp) AS year,
        o.customer_id,
        SUM(oi.price + oi.freight_value) AS total_spent,
        RANK() OVER (
            PARTITION BY EXTRACT(YEAR FROM o.order_purchase_timestamp)
            ORDER BY SUM(oi.price + oi.freight_value) DESC
        ) AS spend_rank
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY year, o.customer_id
) sub
WHERE spend_rank <= 3
ORDER BY year, spend_rank;